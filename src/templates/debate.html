<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ topic.title }} - The Great Debate</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <nav class="header-nav">
            <a href="{{ url_for('index') }}" class="logo-link">
                <h1><span class="logo-emoji">üé≠</span> The Great Debate</h1>
            </a>
        </nav>
        
        <!-- Debug output -->
        <div style="display: none">
            <pre id="debug-topic">Topic object: {{ topic|tojson }}</pre>
        </div>
        
        <h1 id="debate-topic">{{ topic.title }}</h1>
        <div class="debate-area">
            <div class="debate-participants">
                {% if mode == 'player-vs-player' %}
                    <div class="participant human-participant">
                        <div class="human-avatar">üë§</div>
                        <h2>Player 1</h2>
                        <textarea placeholder="Make your argument..."></textarea>
                    </div>
                    <div class="participant human-participant">
                        <div class="human-avatar">üë§</div>
                        <h2>Player 2</h2>
                        <textarea placeholder="Make your argument..."></textarea>
                    </div>
                {% elif mode == 'player-vs-ai' %}
                    <div class="participant human-participant">
                        <div class="human-avatar">üë§</div>
                        <h2>Just a Human</h2>
                        <textarea placeholder="Make your argument..."></textarea>
                    </div>
                    <div class="participant ai-participant">
                        <div class="ai-avatar">ü§ñ</div>
                        <h2>The Rebuttalizer</h2>
                        <div class="ai-status">Computing devastating counterarguments...</div>
                        <textarea class="ai-textarea" readonly></textarea>
                    </div>
                {% else %}
                    <div class="participant ai-participant">
                        <div class="ai-avatar">ü¶æ</div>
                        <h2>Master Debator Bot</h2>
                        <div class="ai-status loading">
                            <span class="loading-message">Training on the entire history of philosophical discourse...</span>
                            <div class="loading-brain">üß†</div>
                        </div>
                        <textarea class="ai-textarea" readonly></textarea>
                    </div>
                    <div class="participant ai-participant">
                        <div class="ai-avatar">ü§ñ</div>
                        <h2>The Rebuttalizer 6000</h2>
                        <div class="ai-status loading">
                            <span class="loading-message">Analyzing 2.7 million logical fallacies...</span>
                            <div class="loading-brain">ü§î</div>
                        </div>
                        <textarea class="ai-textarea" readonly></textarea>
                    </div>
                {% endif %}
            </div>

            <button class="submit-round" {% if mode == 'ai-vs-ai' %}disabled{% endif %}>Submit Round 1</button>

            <div class="judge-area">
                <div class="judge-avatar">‚öñÔ∏è</div>
                <h2>The Judge</h2>
                <div class="judge-status">Waiting for arguments...</div>
                <div class="judgment"></div>
            </div>
        </div>
    </div>

    <script>
        // Common judging messages for all modes
        const judgingMessages = [
            "Consulting the ancient texts of debate law...",
            "Analyzing logical fallacies with quantum precision...",
            "Calibrating the scales of justice...",
            "Reviewing precedents from historical debates...",
            "Meditating on the philosophical implications...",
            "Cross-referencing with the debate constitution...",
            "Polishing the gavel of truth...",
            "Donning the ceremonial robes of judgment..."
        ];

        // Get important values from server
        const DEBATE_MODE = JSON.parse('{{ mode|tojson }}');
        const TOPIC_TITLE = JSON.parse('{{ topic.title|tojson }}');

        // Function to get arguments based on mode
        function getDebateArguments() {
            if (DEBATE_MODE === 'ai-vs-ai' && window.debateArguments) {
                return window.debateArguments;
            }

            // For other modes, get arguments from textareas
            const textareas = document.querySelectorAll('textarea');
            return {
                argument_one: textareas[0].value.trim(),
                argument_two: textareas[1].value.trim()
            };
        }

        async function startJudging() {
            const judgeStatus = document.querySelector('.judge-status');
            const judgmentDiv = document.querySelector('.judgment');
            const submitButton = document.querySelector('.submit-round');
            
            // Validate arguments for non-AI vs AI modes
            if (DEBATE_MODE !== 'ai-vs-ai') {
                const args = getDebateArguments();
                if (!args.argument_one || !args.argument_two) {
                    alert('Both participants must provide arguments before judging can begin!');
                    return;
                }
            }
            
            // Disable submit button permanently
            submitButton.disabled = true;
            
            // Start the judging animation
            let messageIndex = 0;
            const judgingInterval = setInterval(() => {
                judgeStatus.textContent = judgingMessages[messageIndex % judgingMessages.length];
                messageIndex++;
            }, 2000);
            
            try {
                const response = await fetch('/api/judge-debate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        topic: TOPIC_TITLE,
                        ...getDebateArguments()
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const judgment = await response.json();
                
                // Clear the judging animation
                clearInterval(judgingInterval);
                
                // Update the UI with the judgment
                const winner = judgment.winner;
                const winnerElement = document.querySelectorAll('.participant')[winner - 1];
                
                // Add winner animation class
                winnerElement.classList.add('winner');
                
                // Update judge status and show judgment
                judgeStatus.textContent = `The verdict is in!`;
                
                // Get winner name based on mode
                let winnerName;
                if (DEBATE_MODE === 'ai-vs-ai') {
                    winnerName = winner === 1 ? 'Master Debator Bot' : 'The Rebuttalizer 6000';
                } else if (DEBATE_MODE === 'player-vs-ai') {
                    winnerName = winner === 1 ? 'Human' : 'The Rebuttalizer';
                } else {
                    winnerName = `Player ${winner}`;
                }
                
                judgmentDiv.innerHTML = `
                    <div class="judgment-header">
                        <h3>üèÜ Winner: ${winnerName}</h3>
                    </div>
                    <div class="judgment-summary">
                        <h4>Key Deciding Factors:</h4>
                        <ul>
                            ${judgment.summary_points.map(point => `<li>${point}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="judgment-text">
                        <h4>Full Legal Opinion:</h4>
                        ${judgment.explanation}
                    </div>
                `;
                
                // Show the judgment with a fade-in effect
                judgmentDiv.classList.add('show');
                
                // Disable all textareas after judgment
                document.querySelectorAll('textarea').forEach(textarea => {
                    textarea.readOnly = true;
                });
                
            } catch (error) {
                console.error('Error in judging:', error);
                clearInterval(judgingInterval);
                judgeStatus.textContent = `Error: ${error.message}`;
                judgeStatus.classList.add('error');
                // Re-enable button in case of error
                submitButton.disabled = false;
            }
        }

        // Add click handler for submit button for all modes
        document.querySelector('.submit-round').addEventListener('click', startJudging);
    </script>

    {% if mode == 'ai-vs-ai' %}
    <script>
        console.log('Hello world from debate.html!');
        
        const loadingMessages = [
            ["Consulting ancient scrolls...", "Calibrating rhetorical devices..."],
            ["Downloading all of Wikipedia...", "Practicing raised eyebrow technique..."],
            ["Studying Sun Tzu's Art of War...", "Loading npm debate module v42.0.0..."],
            ["Channeling Socrates, Plato and Nietzsche...", "Optimizing snappy comebacks..."],
            ["Scanning Oxford Dictionary for big words...", "Charging debate batteries..."],
            ["Warming up NVIDIA logic processors...", "Polishing rebuttal algorithms..."]
        ];

        let currentMessageIndex = 0;
        const loadingInterval = setInterval(() => {
            const messages = loadingMessages[currentMessageIndex % loadingMessages.length];
            document.querySelectorAll('.loading-message')[0].textContent = messages[0];
            document.querySelectorAll('.loading-message')[1].textContent = messages[1];
            currentMessageIndex++;
        }, 3000);

        async function startAIDebate() {
            try {
                console.log('Making API request...');
                const requestData = {
                    topic: TOPIC_TITLE
                };
                console.log('Request data:', requestData);
                const requestBody = JSON.stringify(requestData);
                console.log('Request body (raw):', requestBody);
                
                const response = await fetch('/api/get-ai-responses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: requestBody
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = JSON.parse(responseText);
                console.log('Parsed data:', data);
                
                // Clear loading interval and update UI
                clearInterval(loadingInterval);
                
                // Update first AI
                const ai1Status = document.querySelectorAll('.ai-status')[0];
                const ai1Textarea = document.querySelectorAll('.ai-textarea')[0];
                ai1Status.innerHTML = `Position: ${data.positions.position_one}`;
                ai1Status.classList.remove('loading');
                ai1Textarea.value = data.arguments.argument_one;
                
                // Update second AI
                const ai2Status = document.querySelectorAll('.ai-status')[1];
                const ai2Textarea = document.querySelectorAll('.ai-textarea')[1];
                ai2Status.innerHTML = `Position: ${data.positions.position_two}`;
                ai2Status.classList.remove('loading');
                ai2Textarea.value = data.arguments.argument_two;
                
                // Enable submit button
                document.querySelector('.submit-round').disabled = false;

                // Store the arguments for judging
                window.debateArguments = {
                    argument_one: data.arguments.argument_one,
                    argument_two: data.arguments.argument_two
                };
            } catch (error) {
                console.error('Error in startAIDebate:', error);
                clearInterval(loadingInterval);
                document.querySelectorAll('.ai-status').forEach(status => {
                    status.innerHTML = `Error: ${error.message}`;
                    status.classList.remove('loading');
                    status.classList.add('error');
                });
            }
        }

        // Start the AI debate process
        startAIDebate();
    </script>
    {% endif %}
</body>
</html> 